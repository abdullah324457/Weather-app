<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weather on Map — Simple Temp Viewer</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      --bg: #0f1115;
      --panel: #151922;
      --text: #eef0f4;
      --muted: #a8b0bf;
      --accent: #4da3ff;
      --accent-2: #a96bff;
      --border: #232838;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, #1b1f2b, #0f1115);
      color: var(--text);
    }
    #app {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100%;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      gap: 12px;
      background: color-mix(in srgb, var(--panel), #000 8%);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 500;
    }
    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 650;
      letter-spacing: 0.2px;
      font-size: 16px;
      white-space: nowrap;
    }
    .title .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 10px color-mix(in srgb, var(--accent), white 20%);
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn, .seg {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #1a1f2c, #121725);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.15s transform ease, 0.2s background ease, 0.2s border-color ease, 0.2s box-shadow ease;
      user-select: none;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .seg {
      display: inline-flex;
      padding: 2px;
      gap: 2px;
      background: linear-gradient(180deg, #1a1f2c, #111522);
    }
    .seg button {
      all: unset;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--muted);
      font-weight: 700;
    }
    .seg button.active {
      color: var(--text);
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent), #fff 5%), color-mix(in srgb, var(--accent-2), #fff 5%));
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent), #000 20%);
    }
    .hint {
      color: var(--muted);
      font-size: 12px;
      opacity: 0.9;
    }
    #map { height: calc(100vh - 58px); width: 100%; }
    .leaflet-popup-content-wrapper {
      background: #0d1220; color: var(--text); border: 1px solid var(--border);
    }
    .leaflet-control-attribution {
      background: rgba(0,0,0,0.45); color: #eaeef7;
      backdrop-filter: blur(4px);
    }
    .legend {
      position: absolute;
      bottom: 14px;
      left: 12px;
      padding: 8px 10px;
      font-size: 12px;
      background: rgba(15,17,21,0.75);
      border: 1px solid var(--border);
      border-radius: 8px;
      z-index: 450;
      line-height: 1.2;
    }
    .legend .bar {
      height: 10px;
      background: linear-gradient(90deg, #2a6cff, #60d5ff, #8cf7a2, #ffd966, #ff934d, #ff4d4d);
      border-radius: 5px;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="title">
        <span class="dot"></span>
        Weather on Map
      </div>
      <div class="controls">
        <div class="seg" id="unitSeg">
          <button data-unit="celsius" class="active">°C</button>
          <button data-unit="fahrenheit">°F</button>
        </div>
        <button class="btn" id="locateBtn">Use my location</button>
        <span class="hint">Tip: click anywhere on the map to see the current temperature.</span>
      </div>
    </header>
    <div id="map"></div>
    <div class="legend" id="legend" aria-hidden="true">
      <div class="bar"></div>
      <div>Cool → Warm</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <script>
    // --- Helpers ---
    function tempToColorCelsius(t) {
      // Map temp (°C) to a color from cool blue to hot red
      const stops = [
        {t:-10, c:[42,108,255]},
        {t:  0, c:[96,213,255]},
        {t: 15, c:[140,247,162]},
        {t: 25, c:[255,217,102]},
        {t: 32, c:[255,147,77]},
        {t: 40, c:[255,77,77]}
      ];
      if (t <= stops[0].t) return "rgb(" + stops[0].c.join(",") + ")";
      if (t >= stops[stops.length-1].t) return "rgb(" + stops[stops.length-1].c.join(",") + ")";
      for (let i=0; i<stops.length-1; i++) {
        const a = stops[i], b = stops[i+1];
        if (t >= a.t && t <= b.t) {
          const f = (t - a.t) / (b.t - a.t);
          const c = a.c.map((v, idx) => Math.round(v + f * (b.c[idx]-v)));
          return `rgb(${c[0]},${c[1]},${c[2]})`;
        }
      }
      return "#ffffff";
    }
    const toF = c => c * 9/5 + 32;

    // --- Map setup ---
    const map = L.map('map', { zoomControl: true }).setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // --- State ---
    let unit = 'celsius';

    // --- UI: unit toggle ---
    const unitSeg = document.getElementById('unitSeg');
    unitSeg.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-unit]');
      if (!btn) return;
      unit = btn.dataset.unit;
      [...unitSeg.querySelectorAll('button')].forEach(b => b.classList.toggle('active', b === btn));
      // Update any existing temp markers' popups to new unit
      tempLayers.forEach(layer => {
        if (layer.__celsius != null) {
          const c = layer.__celsius;
          const display = unit === 'celsius' ? `${c.toFixed(1)} °C` : `${toF(c).toFixed(1)} °F`;
          layer.bindPopup(popupHTML(display, layer.__place));
        }
      });
    });

    // --- UI: locate ---
    const locateBtn = document.getElementById('locateBtn');
    locateBtn.addEventListener('click', () => {
      map.locate({ setView: true, maxZoom: 8 });
    });
    map.on('locationfound', async (e) => {
      await addTempMarker(e.latlng.lat, e.latlng.lng, "Your location");
    });
    map.on('locationerror', () => {
      alert('Unable to get your location. You can still click on the map.');
    });

    // --- Popup template ---
    function popupHTML(tempText, placeText) {
      return `<div style="font-weight:800;font-size:16px;margin-bottom:4px">${tempText}</div>
              <div style="font-size:12px;color:#a8b0bf">${placeText || ''}</div>`;
    }

    // --- Temp markers handling ---
    const tempLayers = [];
    async function addTempMarker(lat, lon, placeLabel) {
      try {
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.searchParams.set('latitude', lat.toFixed(4));
        url.searchParams.set('longitude', lon.toFixed(4));
        url.searchParams.set('current', 'temperature_2m');
        url.searchParams.set('temperature_unit', 'celsius');
        url.searchParams.set('timezone', 'auto');

        const r = await fetch(url.toString());
        if (!r.ok) throw new Error('Network error');
        const data = await r.json();

        const c = data?.current?.temperature_2m;
        if (typeof c !== 'number') throw new Error('No temperature');

        // Reverse geocode for a friendly place label (optional, no key): use Nominatim
        let place = placeLabel || '';
        try {
          const rg = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`,
                                 { headers: { 'Accept-Language': 'en' } });
          if (rg.ok) {
            const j = await rg.json();
            place = j.display_name || place;
          }
        } catch (e) { /* ignore */ }

        const color = tempToColorCelsius(c);
        const circle = L.circleMarker([lat, lon], {
          radius: 12,
          weight: 2,
          color: color,
          fillColor: color,
          fillOpacity: 0.25
        }).addTo(map);

        circle.__celsius = c;
        circle.__place = place;
        const display = unit === 'celsius' ? `${c.toFixed(1)} °C` : `${toF(c).toFixed(1)} °F`;
        circle.bindPopup(popupHTML(display, place)).openPopup();
        tempLayers.push(circle);
        return circle;
      } catch (err) {
        console.error(err);
        alert('Could not fetch temperature here. Try another spot.');
      }
    }

    // --- Click to query temperature ---
    map.on('click', async (e) => {
      await addTempMarker(e.latlng.lat, e.latlng.lng);
    });

    // Center roughly on South Asia for first view (can change)
    // Try passive locate once to zoom closer if allowed
    map.locate({ setView: false, watch: false, enableHighAccuracy: false });
  </script>
</body>
</html>
